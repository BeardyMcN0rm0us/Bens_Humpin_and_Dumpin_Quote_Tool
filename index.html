<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Benâ€™s Humpinâ€™ & Dumpinâ€™ â€” Instant Quote (debug)</title>

<style>
  :root{--bg:#000;--panel:#0e0e0e;--ink:#fff;--muted:#b7b7b7;--brand:#f4a261;--brand2:#e76f51;--ok:#25D366;--line:#1e1e1e;--chip:#141414;--shadow:0 10px 30px rgba(0,0,0,.45)}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:18px}
  .card{background:linear-gradient(180deg,#121212 0%,#0b0b0b 100%);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}
  header{display:flex;flex-direction:column;align-items:center;gap:10px}
  header img{width:110px;height:110px;border-radius:20px;border:1px solid var(--line);object-fit:cover;background:#000}
  h1{margin:4px 0 2px;text-align:center;font-size:1.45rem;color:var(--brand)}
  .sub{color:var(--muted);text-align:center}.build{color:#6f6f6f;text-align:center;font-size:.82rem;margin-top:6px}
  label{display:block;margin:12px 0 6px;color:var(--muted)}
  input,select,textarea{width:100%;padding:14px;border-radius:12px;border:1px solid var(--line);background:#111;color:#fff;outline:none;font-size:1.05rem;transition:all .25s ease}
  textarea{min-height:96px;resize:vertical}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 2px var(--brand);border-color:transparent}
  .btn{width:100%;padding:14px;border:none;border-radius:12px;font-weight:800;cursor:pointer;font-size:1.05rem;transition:transform .08s ease}
  .btn:active{transform:scale(.98)}.btn.primary{background:linear-gradient(135deg,#29d980,#25D366);color:#0b1b12}.btn.secondary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#1b0b08}
  .row{display:flex;gap:12px;flex-wrap:wrap}.muted{color:var(--muted);font-size:.92rem}.hint{font-size:.88rem;color:var(--muted);margin-top:6px;min-height:20px}
  .total{font-weight:900;font-size:1.7rem;text-align:center;margin-top:8px;color:var(--brand);opacity:0;transition:opacity .6s ease}
  .total.show{opacity:1}.hr{height:1px;background:var(--line);margin:12px 0}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:560px){.grid2{grid-template-columns:1fr}}
  .slide{animation:slideUp .35s ease forwards}@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  .hidden,[hidden]{display:none!important}
  .tag{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.85rem}
  .warn{background:#231;border:1px solid #542;color:#ffddb3;padding:10px;border-radius:10px;margin:8px 0}
  #splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;opacity:1;transition:opacity .4s ease}
  #splash img{width:160px;height:160px;border-radius:24px;border:1px solid #222;background:#000;object-fit:cover}
  #splash.hide{opacity:0;pointer-events:none}
  footer{text-align:center;margin-top:24px;color:var(--muted);font-size:.85rem;line-height:1.4}

  /* Debug panel */
  #debug{position:fixed;left:8px;right:8px;bottom:8px;background:#111;border:1px solid #333;color:#eee;
    border-radius:10px;padding:10px;font-size:12px;line-height:1.4;z-index:99999;box-shadow:0 8px 20px rgba(0,0,0,.5)}
  #debug b{color:#9be7ff}
</style>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icon-192.png">
<meta name="theme-color" content="#000000" />
</head>
<body>

<div id="splash"><img src="icon-192.png" alt="Benâ€™s Humpinâ€™ & Dumpinâ€™ logo"></div>

<div class="wrap">
  <header class="card">
    <img src="icon-192.png" alt="Benâ€™s Humpinâ€™ & Dumpinâ€™ logo">
    <h1>Instant Quote</h1>
    <div class="sub">Fast estimate. Final price confirmed after photos & access check.</div>
    <div class="build">Build r39câ€‘debug</div>
  </header>

  <div class="card" id="cfgWarn" style="display:none">
    <div class="warn">Pricing config not loaded â€” refresh. Ensure <code>config.js</code> exists alongside <code>index.html</code>.</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <label for="jobType" style="margin:0;color:#fff">Job Type</label>
      <span class="tag">WhatsApp checkout</span>
    </div>

    <select id="jobType">
      <option value="" selected disabled hidden>Choose a job typeâ€¦</option>
      <option value="tip">Tip Run</option>
      <option value="move">House Move</option>
      <option value="fb">Facebook Marketplace Pickup/Drop-off</option>
      <option value="shop">Emergency Shop Run</option>
      <option value="student">Student Relocation (to/from uni)</option>
      <option value="ikea">IKEA Collect / Collect & Build</option>
      <option value="business">Business Enquiries / Barter Deals</option>
      <option value="other">Other (Tell me what you need)</option>
    </select>

    <div id="ikeaModeWrap" class="hidden" hidden>
      <label for="ikeaMode">IKEA service</label>
      <select id="ikeaMode">
        <option value="collect" selected>Collect Only</option>
        <option value="collectBuild">Collect & Build</option>
      </select>
    </div>
    <div id="ikeaStoreWrap" class="hidden" hidden>
      <label for="ikeaStore">IKEA store</label>
      <select id="ikeaStore"></select>
      <div class="hint">Choosing a store fills the collection address (you can edit it).</div>
    </div>

    <div id="pickupField" class="hidden" hidden>
      <label for="addrPickup">Collection address</label>
      <input id="addrPickup" type="text" placeholder="Start typingâ€¦" autocomplete="street-address">
    </div>
    <div id="addrDropWrap" class="hidden" hidden>
      <label for="addrDrop">Delivery address</label>
      <input id="addrDrop" type="text" placeholder="Start typingâ€¦" autocomplete="street-address">
    </div>

    <div id="shopTimeWrap" class="hidden" hidden>
      <label for="shopTime">Run time (for shop runs)</label>
      <select id="shopTime">
        <option value="before22" selected>Before 10pm</option>
        <option value="after22">After 10pm</option>
      </select>
    </div>

    <div id="ikeaQtyWrap" class="hidden" hidden>
      <label for="ikeaQty">How many items to build?</label>
      <input id="ikeaQty" type="number" min="1" step="1" value="1">
      <div id="ikeaQuickPick" class="row" style="margin-top:8px;flex-wrap:wrap;gap:6px"></div>
      <div class="hint">Tap an item to auto-fill description and bump the quantity.</div>
    </div>

    <input id="mileage" type="number" class="hidden" hidden readonly>

    <div id="twoManWrap" class="hidden" hidden>
      <label for="twoMan">Two-person team?</label>
      <select id="twoMan"><option value="no">No</option><option value="yes">Yes</option></select>
    </div>
    <div id="stairsWrap" class="grid2 hidden" hidden>
      <div><label for="stairsPickup">Stairs at pickup (floors)</label><input id="stairsPickup" type="number" min="0" step="1" value="0"></div>
      <div><label for="stairsDrop">Stairs at drop-off (floors)</label><input id="stairsDrop" type="number" min="0" step="1" value="0"></div>
    </div>

    <div id="wasteWrap" class="hidden" hidden>
      <label for="wasteType">Waste type (Tip runs)</label>
      <select id="wasteType"></select>
      <div class="hint">Weâ€™ll use the minimum disposal fee (25% of the published Â£/tonne). If itâ€™s more, Ben confirms from photos.</div>
    </div>

    <div id="descWrap" class="hidden" hidden>
      <label for="jobDesc">What is it? (Describe the job)</label>
      <textarea id="jobDesc" placeholder="e.g., Billy bookcase + Malm drawers; room & access notesâ€¦"></textarea>
    </div>

    <button id="btnCalc" class="btn secondary" type="button">Calculate Quote</button>
    <div id="routeHint" class="hint">Choose a job type to start. (Debug build: mileage fixed at 0)</div>
  </div>

  <div class="card">
    <div id="quoteId" class="muted">Quote ID â€” (after send)</div>
    <div id="breakdown" class="muted" style="margin-top:6px"></div>
    <div id="total" class="total">Estimated: Â£0â€“Â£0</div>
    <div class="hr"></div>
    <div class="muted"><strong>Estimate only.</strong> Final price depends on access, load & photos. Ben confirms before booking.</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnWhatsApp" class="btn primary hidden" hidden type="button">Send to WhatsApp</button>
    </div>
    <div class="hint" style="margin-top:8px">WhatsApp opens with your details and Benâ€™s number prefilled.</div>
  </div>

  <footer>
    <span id="versionBadge"></span><br>
    <span id="lastUpdated"></span>
  </footer>
</div>

<!-- Load config FIRST -->
<script src="config.js?v=r39c-debug"></script>

<script>
// ==== DEBUG PANEL ====
(function(){
  const box=document.createElement('div'); box.id='debug';
  box.innerHTML='ðŸ”Ž <b>Debug</b> â€” waiting...'; document.body.appendChild(box);
  function log(msg){ box.innerHTML += '<br>'+msg; console.log('[BHD]',msg); }
  window.BHD_DEBUG = { log, box };
  window.addEventListener('error', e => log('âŒ JS error: '+ (e.message||e)));
})();

// ==== Safe config fallback ====
const DEFAULT_CFG = {
  version: "r39c-debug",
  homeAddress: "15 Primrose Hill, Doddington, Cambs, PE15 0SU",
  waterbeachAddress: "Waterbeach Waste Management Park, Ely Road, Waterbeach, Cambridge CB25 9PG",
  whatsappNumber: "447717463496",
  minByType: { tip:"", move:"", fb:"", shop:"", student:"", business:"", other:"", ikea:"" },
  rangePct: { tip:0.15, business:0.15, other:0.15, move:0.12, fb:0.12, student:0.12, shop:0.10, ikea:0.12 },
  baseFees: { default:35, move:50, shopBefore22:25, shopAfter22:40, ikeaCollect:45, ikeaCollectBuild:55 },
  mileagePerMile: 0.40, twoManSurcharge: 20, stairsPerFloor: 5,
  disposalMinPct: 0.25,
  disposal: { general:{label:"General Waste",ratePerTonne:192.50} },
  ikeaAssemblyPerItem: 15, ikeaStores: [], ikeaItems: [], ui:{ splashMs:1200, showShopNoMinNote:true }
};
const CFG = window.BHD_CONFIG || DEFAULT_CFG;
if (!window.BHD_CONFIG) { document.getElementById('cfgWarn').style.display='block'; }
BHD_DEBUG.log('CFG loaded: ' + (!!window.BHD_CONFIG ? 'âœ… external' : 'âš ï¸ fallback') + ' ('+(CFG.version||'n/a')+')');

// ==== Utilities ====
const $=id=>document.getElementById(id);
function show(el){ if(!el) return; el.hidden=false; el.classList.remove('hidden'); el.classList.add('slide'); }
function hide(el){ if(!el) return; el.hidden=true; el.classList.add('hidden'); el.classList.remove('slide'); }

// ==== Constants from config ====
const ADDR = { home: CFG.homeAddress, tipSite: CFG.waterbeachAddress };
const BASE = CFG.baseFees || {}, RANGES = CFG.rangePct || {}, MIN_BY = CFG.minByType || {};
const DISP = CFG.disposal || {}, DISP_MIN = Number(CFG.disposalMinPct ?? 0.25);
const PRICE = { mileagePerMile:Number(CFG.mileagePerMile||0), twoMan:Number(CFG.twoManSurcharge||0), stairsPerFloor:Number(CFG.stairsPerFloor||0), ikeaAssemblyPerItem:Number(CFG.ikeaAssemblyPerItem||0) };

// ==== DOM refs ====
const els={ jobType:$('#jobType'), ikeaModeWrap:$('#ikeaModeWrap'), ikeaMode:$('#ikeaMode'),
  ikeaStoreWrap:$('#ikeaStoreWrap'), ikeaStore:$('#ikeaStore'), pickupField:$('#pickupField'), addrPickup:$('#addrPickup'),
  addrDropWrap:$('#addrDropWrap'), addrDrop:$('#addrDrop'), shopTimeWrap:$('#shopTimeWrap'), shopTime:$('#shopTime'),
  ikeaQtyWrap:$('#ikeaQtyWrap'), ikeaQty:$('#ikeaQty'), ikeaQuickPick:$('#ikeaQuickPick'), twoManWrap:$('#twoManWrap'),
  twoMan:$('#twoMan'), stairsWrap:$('#stairsWrap'), stairsPickup:$('#stairsPickup'), stairsDrop:$('#stairsDrop'),
  wasteWrap:$('#wasteWrap'), wasteType:$('#wasteType'), descWrap:$('#descWrap'), jobDesc:$('#jobDesc'),
  btnCalc:$('#btnCalc'), routeHint:$('#routeHint'), breakdown:$('#breakdown'), total:$('#total'), quoteId:$('#quoteId'),
  btnWA:$('#btnWhatsApp'), versionBadge:$('#versionBadge'), lastUpdated:$('#lastUpdated') };

// ==== State ====
let pickupAddress="", dropAddress="";

// ==== Helpers ====
function nextQuoteId(){const n=new Date(),p=v=>String(v).padStart(2,"0");return `ID${n.getFullYear()}${p(n.getMonth()+1)}${p(n.getDate())}-${p(n.getHours())}${p(n.getMinutes())}${p(n.getSeconds())}`;}
const round5=v=>Math.round(v/5)*5;
const pctFor = jt => Number(RANGES[jt] ?? 0.12);
const minFor = jt => { const v = MIN_BY[jt]; return (v === "" || v == null) ? 0 : Math.max(0, Number(v)); };
function baseFeeFor(jt){
  if(jt==="move") return Number(BASE.move ?? BASE.default ?? 0);
  if(jt==="shop") return (els.shopTime.value==="after22") ? Number(BASE.shopAfter22 ?? BASE.default ?? 0) : Number(BASE.shopBefore22 ?? BASE.default ?? 0);
  if(jt==="ikea") return (els.ikeaMode.value === "collectBuild") ? Number(BASE.ikeaCollectBuild ?? BASE.default ?? 0) : Number(BASE.ikeaCollect ?? BASE.default ?? 0);
  return Number(BASE.default ?? 0);
}

// ==== UI logic ====
function setJobTypeUI(){
  const jt=els.jobType.value || "";
  [els.pickupField,els.addrDropWrap,els.wasteWrap,els.twoManWrap,els.stairsWrap,els.descWrap,els.shopTimeWrap,els.ikeaModeWrap,els.ikeaStoreWrap,els.ikeaQtyWrap]
    .forEach(el=>{ hide(el); if(el) el.hidden=true; });

  if(!jt){els.routeHint.textContent="Choose a job type to start. (Debug build: mileage fixed at 0)"; return;}
  show(els.pickupField);

  if(jt==="tip"){
    const wc = els.wasteType; if (wc){ wc.innerHTML=""; Object.keys(DISP).forEach(key=>{ const o=document.createElement('option'); o.value=key; o.textContent=(DISP[key]?.label)||key; wc.appendChild(o); }); }
    show(els.wasteWrap);
  } else if (jt==="move"||jt==="fb"||jt==="student"){
    show(els.addrDropWrap); show(els.twoManWrap); show(els.stairsWrap);
  } else if (jt==="shop"){
    show(els.addrDropWrap); show(els.shopTimeWrap);
  } else if (jt==="ikea"){
    show(els.ikeaModeWrap); show(els.ikeaStoreWrap); show(els.addrDropWrap); show(els.twoManWrap); show(els.stairsWrap); show(els.descWrap);
    if (els.ikeaMode && els.ikeaMode.value === "collectBuild") show(els.ikeaQtyWrap);
    if (els.ikeaStore && els.ikeaStore.value){ els.addrPickup.value = els.ikeaStore.value; pickupAddress = els.ikeaStore.value; }
  } else if (jt==="business"||jt==="other"){
    show(els.addrDropWrap); show(els.descWrap);
  }
  BHD_DEBUG.log('UI updated for jobType=' + jt);
}

// ==== Disposal calc ====
function calcDisposal(){
  const key=els.wasteType.value;
  const item = DISP[key] || {};
  const rate = Number(item.ratePerTonne || 0);
  const minFee = rate * (Number(CFG.disposalMinPct||0.25));
  return {fee:minFee, detail:`Minimum disposal for ${item.label || key} â€” 25% of Â£${rate.toFixed(2)}/t`};
}

// ==== Quote calc (mileage = 0 in debug) ====
function calculate(){
  const jt=els.jobType.value || "";
  if(!jt){els.breakdown.innerHTML=""; els.total.textContent="Estimated: Â£0â€“Â£0"; els.total.classList.remove('show'); return; }

  const miles = 0; // debug
  const base=baseFeeFor(jt);
  const twoManFee=(jt==="tip"||jt==="shop"||jt==="business"||jt==="other")?0:(els.twoMan.value==="yes"?PRICE.twoMan:0);
  const stairsCost=(jt==="tip"||jt==="shop"||jt==="business"||jt==="other")?0:((parseInt(els.stairsPickup.value)||0)+(parseInt(els.stairsDrop.value)||0))*PRICE.stairsPerFloor;
  const mileageCost=miles*PRICE.mileagePerMile;
  const disp=(jt==="tip")?calcDisposal():{fee:0,detail:""};
  let ikeaAssemblyFee=0;
  if(jt==="ikea" && els.ikeaMode && els.ikeaMode.value==="collectBuild"){
    const qty=Math.max(1,parseInt(els.ikeaQty.value)||1);
    ikeaAssemblyFee = qty * PRICE.ikeaAssemblyPerItem;
  }

  let total = base + mileageCost + stairsCost + twoManFee + disp.fee + ikeaAssemblyFee;

  const lines=[`Base: Â£${base.toFixed(2)}`, `Mileage: Â£${mileageCost.toFixed(2)}`];
  if(stairsCost) lines.push(`Stairs: Â£${stairsCost.toFixed(2)}`);
  if(twoManFee) lines.push(`Two-person: Â£${twoManFee.toFixed(2)}`);
  if(jt==="tip") lines.push(`Disposal: Â£${disp.fee.toFixed(2)} â€” ${disp.detail}`);
  if(jt==="shop") lines.push(`Run time: ${els.shopTime.value==="after22"?"After 10pm":"Before 10pm"}`);
  if(jt==="ikea" && ikeaAssemblyFee) lines.push(`Assembly: Â£${ikeaAssemblyFee.toFixed(2)} (${els.ikeaQty.value} item${(parseInt(els.ikeaQty.value)||1)>1?"s":""})`);

  const pct=Number(RANGES[jt] ?? 0.12);
  let low = round5(total*(1-pct));
  let high = round5(total*(1+pct));
  if(high<low) high=low;

  els.breakdown.innerHTML = lines.length ? ('â€¢ ' + lines.join('<br>â€¢ ')) : '';
  els.total.textContent = `Estimated: Â£${low.toFixed(0)}â€“Â£${high.toFixed(0)}`;
  els.total.classList.add('show');
  BHD_DEBUG.log('Calculated. Total ~ Â£'+total.toFixed(2));
  show(els.btnWA);
}

// ==== WhatsApp ====
function sendWhatsApp(){
  const id=nextQuoteId(); els.quoteId.textContent="Quote ID â€” "+id;
  const lines = (els.breakdown.innerText||'').split('â€¢ ').filter(Boolean);
  const jt=els.jobType.value;
  const msgLines=[
    "Hey Ben! I need something Humpin' & Dumpin'",
    `Quote ID: ${id}`,
    `Job Type: ${jt || "N/A"}`,
    `Collection: ${pickupAddress || els.addrPickup.value.trim() || "N/A"}`,
    (jt==="tip" ? `Destination: Waterbeach Waste Management Park` : `Delivery: ${dropAddress || els.addrDrop.value.trim() || "N/A"}`),
    (lines.length ? `\nBreakdown:\n- ${lines.join("\n- ")}` : ""),
    `${els.total.textContent || ""}`
  ].filter(Boolean);
  const url=`https://wa.me/${CFG.whatsappNumber}?text=${encodeURIComponent(msgLines.join("\n"))}`;
  window.open(url,'_blank');
}

// ==== Boot (no SW, no Maps) ====
document.addEventListener('DOMContentLoaded',()=>{
  const splash = document.getElementById('splash');
  (document.getElementById('versionBadge')||{}).textContent = `Version: ${CFG.version||'n/a'} (debug)`;
  (document.getElementById('lastUpdated')||{}).textContent = `Last updated: ${new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`;
  setTimeout(()=>{ splash.classList.add('hide'); setTimeout(()=> splash.remove(), 450); }, (CFG.ui?.splashMs)||1200);

  // Wire events
  ['change','input'].forEach(evt => els.jobType.addEventListener(evt, setJobTypeUI));
  if (els.ikeaMode) ['change','input'].forEach(evt => els.ikeaMode.addEventListener(evt, setJobTypeUI));
  els.btnCalc.addEventListener('click', calculate);
  els.btnWA.addEventListener('click', sendWhatsApp);

  setJobTypeUI();
  BHD_DEBUG.log('Events wired âœ…');
});
</script>

</body>
</html>