<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ben’s Humpin’ & Dumpin’ — Instant Quote Tool</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#141414"/>
<style>
  :root{--bg:#0b0b0b;--panel:#141414;--text:#fff;--muted:#b7b7b7;--brand:#ff3b30;--brand2:#ff7a00;--ok:#25D366;--border:#242424}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
  .wrap{max-width:820px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0}
  .brand{display:flex;align-items:center;gap:12px;justify-content:center;margin:8px 0 14px}
  .brand h1{margin:0;font-size:1.15rem}
  h2{margin:0 0 8px;font-size:1.05rem;color:var(--brand2)}
  label{display:block;margin:10px 0 6px;color:var(--muted)}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0f0f0f;color:#fff;outline:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#101010;color:#ddd}
  .btn{width:100%;padding:12px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--ok);color:#fff}.btn.secondary{background:var(--brand);color:#fff}
  .total{font-weight:800;font-size:1.6rem;text-align:center;margin-top:6px}
  .muted{color:var(--muted);font-size:.9rem}.hr{height:1px;background:var(--border);margin:12px 0}
  .sm{font-size:.85rem}.hidden{display:none}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brand"><h1>Instant Quote</h1></div>
    <p class="muted" style="text-align:center;margin:0">Enter addresses (or let autocomplete help) — we’ll work out the miles and the price.</p>
  </div>

  <!-- Job type + addresses -->
  <div class="card">
    <h2>Job</h2>
    <div class="grid">
      <div>
        <label for="jobType">Job type</label>
        <select id="jobType">
          <option value="tip">Tip run (to Waterbeach)</option>
          <option value="pd">Pickup & Deliver</option>
          <option value="move">House move / Relocation</option>
          <option value="other">Other (pickup & deliver)</option>
        </select>
      </div>
      <div>
        <label for="mileage">Calculated mileage (round trip)</label>
        <input id="mileage" type="number" min="0" step="0.1" value="0" readonly>
      </div>
    </div>

    <div class="grid" id="addrBlock">
      <div>
        <label for="addrPickup">Collection address</label>
        <input id="addrPickup" type="text" placeholder="Start typing...">
      </div>
      <div id="addrDropWrap">
        <label for="addrDrop">Delivery address</label>
        <input id="addrDrop" type="text" placeholder="Start typing...">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnCalcMiles" class="btn secondary">Recalculate mileage</button>
    </div>

    <p class="muted sm" style="margin-top:10px">
      Route logic: <span id="routeHint"></span>
    </p>
  </div>

  <!-- Extras -->
  <div class="card">
    <h2>Extras</h2>
    <div class="grid">
      <div><label for="trips">Number of trips</label><input id="trips" type="number" min="1" step="1" value="1"></div>
      <div><label for="twoMan">Two-person team?</label>
        <select id="twoMan"><option value="no">No</option><option value="yes">Yes</option></select>
      </div>
    </div>
    <div class="grid">
      <div><label for="stairsPickup">Stairs at pickup (floors)</label><input id="stairsPickup" type="number" min="0" step="1" value="0"></div>
      <div><label for="stairsDrop">Stairs at drop-off (floors)</label><input id="stairsDrop" type="number" min="0" step="1" value="0"></div>
    </div>

    <div class="grid">
      <div>
        <label for="wasteType">Waste type (tip runs / mixed loads)</label>
        <select id="wasteType">
          <option value="mixed">Mixed general</option>
          <option value="inert">Inert (soil/rubble)</option>
          <option value="wood">Wood</option>
          <option value="green">Green waste</option>
          <option value="plaster">Plasterboard</option>
          <option value="mattress">Mattress(es)</option>
          <option value="tyre">Tyre(s)</option>
        </select>
      </div>
      <div>
        <label id="measureLabel" for="wasteMeasure">Weight (tonnes)</label>
        <input id="wasteMeasure" type="number" min="0" step="0.01" value="0">
      </div>
    </div>
  </div>

  <!-- Estimate -->
  <div class="card">
    <h2>Estimate</h2>
    <div id="breakdown" class="muted"></div>
    <div id="total" class="total">Total: £0.00</div>
    <div class="row" style="margin-top:8px">
      <button id="btnWhatsApp" class="btn primary">Send quote via WhatsApp</button>
      <button id="btnCopy" class="btn secondary">Copy quote</button>
    </div>
    <p class="muted sm" style="margin-top:10px">Estimate only — final price confirmed on collection.</p>
  </div>
</div>

<script>
// ===== Fixed addresses (edit if you move depot) =====
const HOME_ADDR = "15 Primrose Hill, Doddington, Cambs, PE15 0SU";
const WATERBEACH_ADDR = "Waterbeach Waste Management Park, Ely Road, Waterbeach, Cambridge CB25 9PG";

// ===== Hidden business rates (tweak here) =====
const RATES = {
  baseFee: 35, mileagePerMile: 0.40, handling: 10, twoMan: 20, stairsPerFloor: 5,
  disposal: {
    mixed:{ ratePerTonne: 150, minFee: 40 },
    inert:{ ratePerTonne: 25,  minFee: 20 },
    wood:{  ratePerTonne: 75,  minFee: 20 },
    green:{ ratePerTonne: 30,  minFee: 20 },
    plaster:{ratePerTonne: 130, minFee: 40 },
    mattress:{ each: 20 }, tyre:{ each: 6 }
  }
};
// WhatsApp
const BUSINESS_WHATSAPP = "447717463496";
const WA_INTRO = "Hey Ben! I need something Humpin' & Dumpin'";

// ===== DOM
const els = {
  jobType: document.getElementById('jobType'),
  mileage: document.getElementById('mileage'),
  trips: document.getElementById('trips'),
  twoMan: document.getElementById('twoMan'),
  stairsPickup: document.getElementById('stairsPickup'),
  stairsDrop: document.getElementById('stairsDrop'),
  wasteType: document.getElementById('wasteType'),
  wasteMeasure: document.getElementById('wasteMeasure'),
  measureLabel: document.getElementById('measureLabel'),
  breakdown: document.getElementById('breakdown'),
  total: document.getElementById('total'),
  addrPickup: document.getElementById('addrPickup'),
  addrDrop: document.getElementById('addrDrop'),
  addrDropWrap: document.getElementById('addrDropWrap'),
  btnCalcMiles: document.getElementById('btnCalcMiles'),
  btnWA: document.getElementById('btnWhatsApp'),
  btnCopy: document.getElementById('btnCopy'),
  routeHint: document.getElementById('routeHint')
};

// ===== Google bits
let placesPickup, placesDrop, directions;
let pickupAddress = "", dropAddress = "";
let placeSessionToken = null; // improves billing/accuracy for Places

function newPlacesSession(){ placeSessionToken = new google.maps.places.AutocompleteSessionToken(); }

function updateMeasureLabel(){
  const t = els.wasteType.value;
  if(t==="mattress"||t==="tyre"){ els.measureLabel.textContent="Quantity (items)"; els.wasteMeasure.step="1"; }
  else { els.measureLabel.textContent="Weight (tonnes)"; els.wasteMeasure.step="0.01"; }
}

function calcDisposal(){
  const t = els.wasteType.value; const qty = parseFloat(els.wasteMeasure.value)||0;
  if(t==="mattress"){ const each = RATES.disposal.mattress.each; return {fee: qty*each, detail:`Mattress x ${qty} @ £${each.toFixed(2)}`}; }
  if(t==="tyre"){ const each = RATES.disposal.tyre.each; return {fee: qty*each, detail:`Tyres x ${qty} @ £${each.toFixed(2)}`}; }
  const rate = RATES.disposal[t].ratePerTonne; const min = RATES.disposal[t].minFee;
  let fee = qty*rate; if(qty>0 && fee<min) fee = min;
  return {fee, detail:`${qty}t @ £${rate}/t (min £${min})`};
}

function calculate(){
  const miles = parseFloat(els.mileage.value)||0;
  const trips = parseInt(els.trips.value)||1;
  const twoManFee = (els.twoMan.value==="yes") ? RATES.twoMan : 0;
  const stairsPick = parseInt(els.stairsPickup.value)||0;
  const stairsDrop = parseInt(els.stairsDrop.value)||0;
  const mileageCost = miles*RATES.mileagePerMile*trips;
  const stairsCost = (stairsPick + stairsDrop) * RATES.stairsPerFloor;
  const disposal = calcDisposal();
  const total = RATES.baseFee + RATES.handling + mileageCost + stairsCost + twoManFee + disposal.fee;

  const lines = [
    `Base: £${RATES.baseFee.toFixed(2)}`,
    `Handling: £${RATES.handling.toFixed(2)}`,
    `Mileage: £${mileageCost.toFixed(2)} (${miles} mi × £${RATES.mileagePerMile.toFixed(2)} × ${trips} trip[s])`,
    stairsCost?`Stairs: £${stairsCost.toFixed(2)}`:"",
    twoManFee?`Two-person team: £${twoManFee.toFixed(2)}`:"",
    `Disposal: £${disposal.fee.toFixed(2)} — ${disposal.detail}`
  ].filter(Boolean);

  els.breakdown.innerHTML = '• ' + lines.join('<br>• ');
  els.total.textContent = 'Total: £' + total.toFixed(2);
  return { total: total.toFixed(2) };
}

// Build route based on job type
function getRouteStops(){
  const jt = els.jobType.value;
  const pick = pickupAddress || els.addrPickup.value.trim();
  const drop = dropAddress || els.addrDrop.value.trim();
  if(jt==="tip"){
    return { origin: HOME_ADDR, waypoints: [pick, WATERBEACH_ADDR], destination: HOME_ADDR };
  } else {
    return { origin: HOME_ADDR, waypoints: [pick, drop], destination: HOME_ADDR };
  }
}

// Inline status message (no popups)
function setStatus(msg){
  els.routeHint.textContent = msg || "";
}

// Calculate mileage ONLY when inputs are valid
function calcMileage(){
  const jt = els.jobType.value;
  setStatus(jt==="tip" ? "Home → Collection → Waterbeach → Home" : "Home → Pickup → Drop-off → Home");

  const pick = (pickupAddress || els.addrPickup.value.trim());
  if(!pick){ setStatus("Enter collection address to calculate mileage."); return; }

  if(jt!=="tip"){
    const drop = (dropAddress || els.addrDrop.value.trim());
    if(!drop){ setStatus("Enter delivery address to calculate mileage."); return; }
  }

  const { origin, waypoints, destination } = getRouteStops();
  const req = {
    origin, destination,
    travelMode: google.maps.TravelMode.DRIVING,
    waypoints: waypoints.filter(Boolean).map(a=>({location:a, stopover:true})),
    optimizeWaypoints: false
  };

  directions.route(req, (result, status)=>{
    if(status !== "OK" || !result || !result.routes || !result.routes[0]){
      setStatus("Couldn’t calculate route. Check addresses or API key restrictions.");
      return;
    }
    const legs = result.routes[0].legs || [];
    let meters = 0; legs.forEach(l => meters += (l.distance?.value||0));
    const miles = meters / 1609.344;
    els.mileage.value = miles.toFixed(1);
    setStatus("Mileage updated.");
    calculate();
  });
}

// Autocomplete + UI state
function onJobTypeChanged(){
  const jt = els.jobType.value;
  if(jt==="tip"){
    els.addrDropWrap.classList.add('hidden');
  } else {
    els.addrDropWrap.classList.remove('hidden');
  }
  // DO NOT auto-calc here; wait for addresses
  setStatus(jt==="tip" ? "Enter collection address for route." : "Enter pickup and drop-off for route.");
}

function initAutocomplete(){
  newPlacesSession();
  const baseOpt = { fields: ["formatted_address", "geometry"], componentRestrictions: { country: ["gb"] } };
  const optPickup = Object.assign({ sessionToken: placeSessionToken }, baseOpt);
  const optDrop   = Object.assign({ sessionToken: placeSessionToken }, baseOpt);

  placesPickup = new google.maps.places.Autocomplete(els.addrPickup, optPickup);
  placesDrop   = new google.maps.places.Autocomplete(els.addrDrop,   optDrop);

  placesPickup.addListener('place_changed', ()=>{
    const p = placesPickup.getPlace();
    pickupAddress = p?.formatted_address || els.addrPickup.value.trim();
    calcMileage();
  });

  placesDrop.addListener('place_changed', ()=>{
    const p = placesDrop.getPlace();
    dropAddress = p?.formatted_address || els.addrDrop.value.trim();
    calcMileage();
  });

  // Also recalc when user hits the button
  els.btnCalcMiles.addEventListener('click', calcMileage);
}

function initApp(){
  directions = new google.maps.DirectionsService();
  onJobTypeChanged();
  updateMeasureLabel();
  calculate();
}

window.initMapsStuff = function(){
  try {
    initAutocomplete();
    initApp();
  } catch(e){
    setStatus("Maps failed to initialise. Check API key and enabled APIs.");
  }
};

// Events (no alerts)
document.querySelectorAll('input,select').forEach(el=>{
  el.addEventListener('input', ()=>{ updateMeasureLabel(); calculate(); });
  el.addEventListener('change', ()=>{ updateMeasureLabel(); calculate(); });
});

document.getElementById('btnWhatsApp').addEventListener('click', ()=>{
  const { total } = calculate();
  const msg = `${WA_INTRO}\n\nEstimated total: £${total}`;
  window.open(`https://wa.me/${BUSINESS_WHATSAPP}?text=${encodeURIComponent(msg)}`,'_blank');
});
document.getElementById('btnCopy').addEventListener('click', ()=>{
  const { total } = calculate();
  navigator.clipboard?.writeText(`${WA_INTRO}\n\nEstimated total: £${total}`).then(()=>alert('Quote copied'));
});
</script>

<!-- Google APIs -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAFD3GM-urpM6VqVWdzk8G2-Qgvg4UrZY&libraries=places&callback=initMapsStuff">
</script>

<script>
// PWA: register service worker
if ("serviceWorker" in navigator) {
  window.addEventListener("load", ()=> navigator.serviceWorker.register("./service-worker.js").catch(()=>{}));
}
</script>
</body>
</html>
