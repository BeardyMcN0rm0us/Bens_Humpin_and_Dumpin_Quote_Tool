<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ben’s Humpin’ & Dumpin’ — Instant Quote (r201‑diag)</title>
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icon-192.png">
<style>
  :root{--bg:#000;--panel:#0e0e0e;--ink:#fff;--muted:#b7b7b7;--brand:#f4a261;--brand2:#e76f51;--ok:#25D366;--err:#ff6b6b;--line:#1e1e1e;--chip:#141414;--shadow:0 10px 30px rgba(0,0,0,.45)}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:18px}
  .card{background:linear-gradient(180deg,#121212 0%,#0b0b0b 100%);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}
  header{display:flex;flex-direction:column;align-items:center;gap:10px}
  header img{width:110px;height:110px;border-radius:20px;border:1px solid var(--line);object-fit:cover;background:#000}
  h1{margin:4px 0 2px;text-align:center;font-size:1.45rem;color:var(--brand)}
  .sub{color:var(--muted);text-align:center}.build{color:#6f6f6f;text-align:center;font-size:.82rem;margin-top:6px}
  label{display:block;margin:12px 0 6px;color:var(--muted)}
  input,select,textarea{width:100%;padding:14px;border-radius:12px;border:1px solid var(--line);background:#111;color:#fff;outline:none;font-size:1.05rem;transition:all .25s ease}
  textarea{min-height:96px;resize:vertical}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 2px var(--brand);border-color:transparent}
  .btn{width:100%;padding:14px;border:none;border-radius:12px;font-weight:800;cursor:pointer;font-size:1.05rem;transition:transform .08s ease}
  .btn:active{transform:scale(.98)}.btn.primary{background:linear-gradient(135deg,#29d980,#25D366);color:#0b1b12}.btn.secondary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#1b0b08}
  .row{display:flex;gap:12px;flex-wrap:wrap}.muted{color:var(--muted);font-size:.92rem}.hint{font-size:.88rem;color:var(--muted);margin-top:6px;min-height:20px}
  .total{font-weight:900;font-size:1.7rem;text-align:center;margin-top:8px;color:var(--brand);opacity:0;transition:opacity .6s ease}
  .total.show{opacity:1}.hr{height:1px;background:var(--line);margin:12px 0}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:560px){.grid2{grid-template-columns:1fr}}
  .slide{animation:slideUp .35s ease forwards}@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  .hidden,[hidden]{display:none!important}
  .tag{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.85rem}
  footer{text-align:center;margin-top:24px;color:var(--muted);font-size:.85rem;line-height:1.4}
  /* on-page debug bar */
  #dbg{position:fixed;left:10px;right:10px;bottom:10px;background:#0f0f0f;border:1px solid #222;border-radius:12px;padding:10px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;color:#cfcfcf;z-index:9999}
  #dbg b{color:#fff} .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:#ffd166}
</style>

<!-- ===== EDITABLE SETTINGS (update here) ===== -->
<script>
window.BHD = {
  version: "r201-diag",
  whatsappNumber: "447717463496",

  homeAddress: "15 Primrose Hill, Doddington, Cambs, PE15 0SU",
  waterbeachAddress: "Waterbeach Waste Management Park, CB25 9PG",

  mileagePerMile: 0.40,
  twoManSurcharge: 20,
  stairsPerFloor: 5,

  baseFees: { default: 35, move: 50, shopBefore22: 25, shopAfter22: 40, ikeaCollect: 45, ikeaCollectBuild: 55 },
  minByType: { tip:"", move:"", fb:"", shop:"", student:"", business:"", other:"", ikea:"" },
  rangePct: { tip:0.15, move:0.12, fb:0.12, shop:0.10, student:0.12, business:0.15, other:0.15, ikea:0.12 },

  disposalMinPct: 0.25,
  disposal: {
    general:{label:"General Waste",ratePerTonne:192.50},
    soil:{label:"Soil/Inert",ratePerTonne:69.75},
    hardcore:{label:"Hardcore",ratePerTonne:25.75},
    plaster:{label:"Plasterboard",ratePerTonne:105.00},
    wood:{label:"Mixed Wood",ratePerTonne:91.00},
    mdf:{label:"MDF",ratePerTonne:175.00},
    metal:{label:"Metals",ratePerTonne:27.00},
    plastics:{label:"Rigid/Agricultural Plastics",ratePerTonne:186.23},
    green:{label:"Green material",ratePerTonne:90.00},
    cardboard:{label:"Cardboard (clean)",ratePerTonne:25.00},
    dmr:{label:"Dry Mixed Recycling",ratePerTonne:145.00},
    wuds:{label:"WUDs & POPs",ratePerTonne:345.00}
  },

  ikeaAssemblyPerItem: 15,
  ikeaStores: [
    { name: "IKEA Milton Keynes", address: "Geldered Close, Bletchley, Milton Keynes" },
    { name: "IKEA Peterborough Click & Collect", address: "Boongate, Peterborough" }
  ]
};
</script>
</head>
<body>
<div id="dbg">⏳ <b>Diag:</b> loading…</div>

<div class="wrap">
  <header class="card">
    <img src="icon-192.png" alt="Ben’s Humpin’ & Dumpin’ logo">
    <h1>Instant Quote</h1>
    <div class="sub">Fast estimate. Final price confirmed after photos & access check.</div>
    <div class="build">Build <span id="buildTag">r201</span></div>
  </header>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <label for="jobType" style="margin:0;color:#fff">Job Type</label>
      <span class="tag">WhatsApp checkout</span>
    </div>

    <select id="jobType" onchange="window.BHD_forceUI && window.BHD_forceUI()">
      <option value="" selected disabled hidden>Choose a job type…</option>
      <option value="tip">Tip Run</option>
      <option value="move">House Move</option>
      <option value="fb">Facebook Marketplace Pickup/Drop-off</option>
      <option value="shop">Emergency Shop Run</option>
      <option value="student">Student Relocation (to/from uni)</option>
      <option value="ikea">IKEA Collect / Collect & Build</option>
      <option value="business">Business Enquiries / Barter Deals</option>
      <option value="other">Other (Tell me what you need)</option>
    </select>

    <div id="ikeaModeWrap" class="hidden" hidden>
      <label for="ikeaMode">IKEA service</label>
      <select id="ikeaMode"><option value="collect" selected>Collect Only</option><option value="collectBuild">Collect & Build</option></select>
    </div>
    <div id="ikeaStoreWrap" class="hidden" hidden>
      <label for="ikeaStore">IKEA store</label>
      <select id="ikeaStore"></select>
      <div class="hint">Choosing a store fills the collection address (you can edit it).</div>
    </div>

    <div id="pickupField" class="hidden" hidden>
      <label for="addrPickup">Collection address</label>
      <input id="addrPickup" type="text" placeholder="Start typing…" autocomplete="street-address">
    </div>
    <div id="addrDropWrap" class="hidden" hidden>
      <label for="addrDrop">Delivery address / destination</label>
      <input id="addrDrop" type="text" placeholder="Start typing…" autocomplete="street-address">
    </div>

    <div id="shopTimeWrap" class="hidden" hidden>
      <label for="shopTime">Run time (for shop runs)</label>
      <select id="shopTime"><option value="before22" selected>Before 10pm</option><option value="after22">After 10pm</option></select>
    </div>

    <div id="ikeaQtyWrap" class="hidden" hidden>
      <label for="ikeaQty">How many items to build?</label>
      <input id="ikeaQty" type="number" min="1" step="1" value="1">
    </div>

    <div id="twoManWrap" class="hidden" hidden>
      <label for="twoMan">Two-person team?</label>
      <select id="twoMan"><option value="no">No</option><option value="yes">Yes</option></select>
    </div>
    <div id="stairsWrap" class="grid2 hidden" hidden>
      <div><label for="stairsPickup">Stairs at pickup (floors)</label><input id="stairsPickup" type="number" min="0" step="1" value="0"></div>
      <div><label for="stairsDrop">Stairs at drop-off (floors)</label><input id="stairsDrop" type="number" min="0" step="1" value="0"></div>
    </div>

    <div id="wasteWrap" class="hidden" hidden>
      <label for="wasteType">Waste type (Tip runs)</label>
      <select id="wasteType"></select>
      <div class="hint">We use the minimum disposal fee (25% of the published £/tonne). If it’s more, Ben confirms from photos.</div>
    </div>

    <div id="descWrap" class="hidden" hidden>
      <label for="jobDesc">What is it? (Describe the job)</label>
      <textarea id="jobDesc" placeholder="e.g., sofa + access notes…"></textarea>
    </div>

    <button id="btnCalc" class="btn secondary" type="button">Calculate Quote</button>
    <div id="routeHint" class="hint">Choose a job type to start.</div>
  </div>

  <div class="card">
    <div id="quoteId" class="muted">Quote ID — (after send)</div>
    <div id="breakdown" class="muted" style="margin-top:6px"></div>
    <div id="total" class="total">Estimated: £0–£0</div>
    <div class="hr"></div>
    <div class="muted"><strong>Estimate only.</strong> Final price depends on access, load & photos. Ben confirms before booking.</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnWhatsApp" class="btn primary hidden" hidden type="button">Send to WhatsApp</button>
    </div>
    <div class="hint" style="margin-top:8px">WhatsApp opens with your details and Ben’s number prefilled.</div>
  </div>

  <footer>
    <span id="lastUpdated"></span>
  </footer>
</div>

<script>
(function(){
  const logEl = document.getElementById('dbg');
  const log = (m,cls)=>{ logEl.innerHTML = (cls?`<span class="${cls}">${m}</span>`:m); console.log('[diag]', m); };

  try{
    log('✅ Script loaded — wiring UI…','ok');

    // helpers
    var $=id=>document.getElementById(id);
    var show=el=>{ if(!el)return; el.hidden=false; el.classList.remove('hidden'); el.classList.add('slide'); };
    var hide=el=>{ if(!el)return; el.hidden=true; el.classList.add('hidden'); el.classList.remove('slide'); };
    var round5=v=>Math.round(v/5)*5;
    var metersToMiles=m=>m/1609.344;
    var legsMeters=legs=>{let s=0; for(let i=0;i<legs.length;i++){ s += (legs[i].distance&&legs[i].distance.value)?legs[i].distance.value:0; } return s; };
    var nextQuoteId=()=>{let n=new Date(),p=v=>String(v).padStart(2,"0"); return `ID${n.getFullYear()}${p(n.getMonth()+1)}${p(n.getDate())}-${p(n.getHours())}${p(n.getMinutes())}${p(n.getSeconds())}`};

    var CFG=window.BHD;
    document.getElementById('buildTag').textContent=CFG.version;
    document.getElementById('lastUpdated').textContent="Last updated: "+new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});

    var els={jobType:$('#jobType'), ikeaModeWrap:$('#ikeaModeWrap'), ikeaMode:$('#ikeaMode'),
      ikeaStoreWrap:$('#ikeaStoreWrap'), ikeaStore:$('#ikeaStore'), pickupField:$('#pickupField'),
      addrPickup:$('#addrPickup'), addrDropWrap:$('#addrDropWrap'), addrDrop:$('#addrDrop'),
      shopTimeWrap:$('#shopTimeWrap'), shopTime:$('#shopTime'), ikeaQtyWrap:$('#ikeaQtyWrap'), ikeaQty:$('#ikeaQty'),
      twoManWrap:$('#twoManWrap'), twoMan:$('#twoMan'), stairsWrap:$('#stairsWrap'),
      stairsPickup:$('#stairsPickup'), stairsDrop:$('#stairsDrop'), wasteWrap:$('#wasteWrap'),
      wasteType:$('#wasteType'), descWrap:$('#descWrap'), jobDesc:$('#jobDesc'),
      btnCalc:$('#btnCalc'), routeHint:$('#routeHint'), breakdown:$('#breakdown'),
      total:$('#total'), quoteId:$('#quoteId'), btnWA:$('#btnWhatsApp') };

    // seed waste
    els.wasteType.innerHTML=""; Object.keys(CFG.disposal).forEach(k=>{ let o=document.createElement('option'); o.value=k; o.textContent=CFG.disposal[k].label+` (£${CFG.disposal[k].ratePerTonne.toFixed(2)}/t)`; els.wasteType.appendChild(o); });

    // seed IKEA stores
    els.ikeaStore.innerHTML=""; let ph=document.createElement('option'); ph.value=""; ph.textContent="Select IKEA store…"; ph.disabled=true; ph.selected=true; els.ikeaStore.appendChild(ph);
    CFG.ikeaStores.forEach(st=>{let o=document.createElement('option'); o.value=st.address; o.textContent=st.name; els.ikeaStore.appendChild(o);});
    els.ikeaStore.addEventListener('change', ()=>{ els.addrPickup.value = els.ikeaStore.value; });

    function pctFor(jt){ let v=CFG.rangePct[jt]; return (v==null)?0.12:Number(v); }
    function minFor(jt){ let v=CFG.minByType[jt]; return (v===""||v==null)?0:Math.max(0,Number(v)); }
    function baseFeeFor(jt){
      if(jt==="move") return Number(CFG.baseFees.move||CFG.baseFees.default||0);
      if(jt==="shop") return (els.shopTime.value==="after22")?Number(CFG.baseFees.shopAfter22||CFG.baseFees.default||0):Number(CFG.baseFees.shopBefore22||CFG.baseFees.default||0);
      if(jt==="ikea") return (els.ikeaMode.value==="collectBuild")?Number(CFG.baseFees.ikeaCollectBuild||CFG.baseFees.default||0):Number(CFG.baseFees.ikeaCollect||CFG.baseFees.default||0);
      return Number(CFG.baseFees.default||0);
    }
    function calcDisposal(){
      let key=els.wasteType.value, item=CFG.disposal[key]||{};
      let minFee=Number(item.ratePerTonne||0)*Number(CFG.disposalMinPct||0.25);
      return {fee:minFee, detail:`Minimum disposal for ${item.label||key} — ${Math.round((Number(CFG.disposalMinPct||0.25))*100)}% of £${Number(item.ratePerTonne||0).toFixed(2)}/t`};
    }

    function setJobTypeUI(){
      let jt = els.jobType.value || "";
      let blocks=[els.pickupField,els.addrDropWrap,els.wasteWrap,els.twoManWrap,els.stairsWrap,els.descWrap,els.shopTimeWrap,els.ikeaModeWrap,els.ikeaStoreWrap,els.ikeaQtyWrap];
      blocks.forEach(hide);
      if(!jt){ els.routeHint.textContent="Choose a job type to start."; log('🟡 jobType changed → (empty)','warn'); return; }
      show(els.pickupField);
      if(jt==='tip'){ show(els.wasteWrap); els.routeHint.textContent="Mileage: Home → Collection → Waterbeach (with >50mi rule)."; }
      else if(jt==='move'||jt==='fb'||jt==='student'){ show(els.addrDropWrap); show(els.twoManWrap); show(els.stairsWrap); els.routeHint.textContent="Mileage: Home → Pickup → Delivery."; }
      else if(jt==='shop'){ show(els.addrDropWrap); show(els.shopTimeWrap); els.routeHint.textContent="Mileage: Home → Shop → Delivery."; }
      else if(jt==='ikea'){ show(els.ikeaModeWrap); show(els.ikeaStoreWrap); show(els.addrDropWrap); show(els.twoManWrap); show(els.stairsWrap); show(els.descWrap); if(els.ikeaMode.value==='collectBuild') show(els.ikeaQtyWrap); els.routeHint.textContent="Mileage: Home → IKEA → Delivery."; }
      else if(jt==='business'||jt==='other'){ show(els.addrDropWrap); show(els.descWrap); els.routeHint.textContent="Mileage: Home → Pickup → Delivery."; }
      log('✅ jobType changed → '+jt,'ok');
    }
    window.BHD_forceUI = setJobTypeUI;

    var directions=null;
    window.initMapsStuff = function(){
      try{
        directions = new google.maps.DirectionsService();
        let opt={fields:["formatted_address"], componentRestrictions:{country:["gb"]}};
        new google.maps.places.Autocomplete(els.addrPickup,opt);
        new google.maps.places.Autocomplete(els.addrDrop,opt);
        log('✅ Google Maps initialised','ok');
      }catch(e){ log('❌ Maps init failed: '+e,'err'); }
    };

    function route(req, note, cb){
      if(!directions){ log('❌ No DirectionsService','err'); cb(0); return; }
      directions.route(req, function(r,s){
        if(s!=="OK"){ log('❌ Route error: '+s,'err'); cb(0); return; }
        let miles = metersToMiles(legsMeters(r.routes[0].legs));
        els.routeHint.textContent = note + ": " + miles.toFixed(1) + " mi.";
        log('✅ Route '+note+' → '+miles.toFixed(1)+' mi','ok');
        cb(miles);
      });
    }

    function getMiles(cb){
      let jt=els.jobType.value, home=CFG.homeAddress, tip=CFG.waterbeachAddress, pickup=(els.addrPickup.value||"").trim(), drop=(els.addrDrop.value||"").trim();
      if(!pickup){ log('🟡 Need pickup address','warn'); els.routeHint.textContent="Enter collection address."; return cb(0); }
      if(jt!=="tip" && !drop){ log('🟡 Need delivery address','warn'); els.routeHint.textContent="Enter delivery address."; return cb(0); }

      if(jt==="tip"){
        route({origin:home,destination:pickup,travelMode:'DRIVING'}, "Home→Collection", function(m1){
          if(m1<=50){
            route({origin:pickup,destination:tip,travelMode:'DRIVING'}, "Collection→Waterbeach", cb);
          }else{
            route({origin:home,destination:tip,waypoints:[{location:pickup,stopover:true}],travelMode:'DRIVING'}, ">50mi (Home + Collection→Waterbeach)", cb);
          }
        });
        return;
      }

      // All other types (one-way)
      route({origin:home,destination:drop,waypoints:[{location:pickup,stopover:true}],travelMode:'DRIVING'}, "One‑way", cb);
    }

    function calculate(miles){
      let jt=els.jobType.value||""; if(!jt){ log('🟡 calc blocked (no job type)','warn'); return; }
      function pctFor(j){ let v=CFG.rangePct[j]; return (v==null)?0.12:Number(v); }
      function minFor(j){ let v=CFG.minByType[j]; return (v===""||v==null)?0:Math.max(0,Number(v)); }
      function baseFeeFor(j){
        if(j==="move") return Number(CFG.baseFees.move||CFG.baseFees.default||0);
        if(j==="shop") return (els.shopTime.value==="after22")?Number(CFG.baseFees.shopAfter22||CFG.baseFees.default||0):Number(CFG.baseFees.shopBefore22||CFG.baseFees.default||0);
        if(j==="ikea") return (els.ikeaMode.value==="collectBuild")?Number(CFG.baseFees.ikeaCollectBuild||CFG.baseFees.default||0):Number(CFG.baseFees.ikeaCollect||CFG.baseFees.default||0);
        return Number(CFG.baseFees.default||0);
      }
      let base=baseFeeFor(jt);
      let mileageCost=(miles||0)*Number(CFG.mileagePerMile||0);
      let twoMan=(jt==="tip"||jt==="shop"||jt==="business"||jt==="other")?0:(els.twoMan.value==="yes"?Number(CFG.twoManSurcharge||0):0);
      let stairs=(jt==="tip"||jt==="shop"||jt==="business"||jt==="other")?0:(((+els.stairsPickup.value||0)+(+els.stairsDrop.value||0))*Number(CFG.stairsPerFloor||0));
      let disp=(jt==="tip")? (function(){let key=els.wasteType.value, item=CFG.disposal[key]||{}, fee=Number(item.ratePerTonne||0)*Number(CFG.disposalMinPct||0.25); return {fee:fee,txt:`Minimum disposal for ${item.label||key}`};})() : {fee:0,txt:""};

      let ikeaAsm=0; if(jt==="ikea" && els.ikeaMode.value==="collectBuild"){ let qty=Math.max(1,parseInt(els.ikeaQty.value)||1); ikeaAsm = qty * Number(CFG.ikeaAssemblyPerItem||0); }

      let total=base+mileageCost+stairs+twoMan+disp.fee+ikeaAsm;
      let lines=[`Base: £${base.toFixed(2)}`,`Mileage: £${mileageCost.toFixed(2)}`];
      if(stairs) lines.push(`Stairs: £${stairs.toFixed(2)}`);
      if(twoMan) lines.push(`Two-person: £${twoMan.toFixed(2)}`);
      if(jt==="tip") lines.push(`Disposal: £${disp.fee.toFixed(2)} — ${disp.txt}`);
      if(jt==="shop") lines.push(`Run time: ${els.shopTime.value==="after22"?"After 10pm":"Before 10pm"}`);
      if(jt==="ikea" && ikeaAsm) lines.push(`Assembly: £${ikeaAsm.toFixed(2)} (${els.ikeaQty.value} item${((+els.ikeaQty.value||1)>1)?"s":""})`);

      let MIN=minFor(jt); if(MIN>0 && total<MIN){ lines.push("Minimum charge applied"); total=MIN; }
      let pct=pctFor(jt); let low=round5(total*(1-pct)), high=round5(total*(1+pct)); if(high<low) high=low;

      els.breakdown.innerHTML='• '+lines.join('<br>• ');
      els.total.textContent=`Estimated: £${low.toFixed(0)}–£${high.toFixed(0)}`;
      els.total.classList.add('show');
      els.quoteId.textContent="Quote ID — "+nextQuoteId();
      show(els.btnWA);
      log('✅ Quote calculated','ok');
    }

    function sendWA(){
      let id=(els.quoteId.textContent||"").replace("Quote ID — ","").trim();
      let jt=els.jobType.value;
      let lines=(els.breakdown.innerText||'').split('• ').filter(Boolean);
      let msg=[
        "Hey Ben! I need something Humpin' & Dumpin'",
        "Quote ID: "+id,
        "Job Type: "+(jt||"N/A"),
        "Collection: "+(els.addrPickup.value||"N/A"),
        (jt==="tip" ? "Destination: Waterbeach Waste Management Park" : "Delivery: "+(els.addrDrop.value||"N/A")),
        (lines.length ? "\nBreakdown:\n- "+lines.join("\n- ") : ""),
        (els.total.textContent || "")
      ].filter(Boolean).join("\n");
      window.open("https://wa.me/"+window.BHD.whatsappNumber+"?text="+encodeURIComponent(msg),'_blank');
      log('✅ WhatsApp opened','ok');
    }

    // Bind UI
    ['change','input'].forEach(ev=>els.jobType.addEventListener(ev, ()=>{ setJobTypeUI(); }));
    if (els.ikeaMode) ['change','input'].forEach(ev=>els.ikeaMode.addEventListener(ev, ()=>{ setJobTypeUI(); }));
    els.btnCalc.addEventListener('click', ()=>{ log('… routing for mileage'); getMiles(calculate); });
    els.btnWA.addEventListener('click', sendWA);

    // Initial UI
    setJobTypeUI();
    log('✅ Listeners attached — change the dropdown','ok');

    // Global error hook
    window.onerror=function(msg,src,line,col,err){ log('❌ JS error: '+msg+' @'+(src||'')+':'+(line||'?'),'err'); };
  }catch(e){
    log('❌ Boot error: '+e,'err');
  }
})();
</script>

<!-- Maps (key must be injected by your workflow) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=__MAPS_API_KEY__&libraries=places&callback=initMapsStuff&v=weekly&cbust=r201"></script>
</body>
</html>