<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ben’s Humpin’ & Dumpin’ — Instant Quote</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icon-192.png">
<meta name="theme-color" content="#000000" />

<style>
  :root{
    --bg:#000; --panel:#0e0e0e; --ink:#fff; --muted:#b7b7b7;
    --brand:#f4a261; --brand2:#e76f51; --ok:#25D366; --line:#1e1e1e;
    --chip:#141414; --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:18px}
  .card{
    background:linear-gradient(180deg,#121212 0%, #0b0b0b 100%);
    border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;
    box-shadow:var(--shadow);
  }
  header{display:flex;flex-direction:column;align-items:center;gap:10px}
  header img{width:110px;height:110px;border-radius:20px;border:1px solid var(--line);object-fit:cover;background:#000}
  h1{margin:4px 0 2px;text-align:center;font-size:1.45rem;color:var(--brand)}
  .sub{color:var(--muted);text-align:center}
  .build{color:#6f6f6f;text-align:center;font-size:.82rem;margin-top:6px}

  label{display:block;margin:12px 0 6px;color:var(--muted)}
  input,select,textarea{
    width:100%;padding:14px;border-radius:12px;border:1px solid var(--line);
    background:#111;color:#fff;outline:none;font-size:1.05rem;transition:all .25s ease
  }
  textarea{min-height:96px;resize:vertical}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 2px var(--brand);border-color:transparent}

  .btn{width:100%;padding:14px;border:none;border-radius:12px;font-weight:800;cursor:pointer;font-size:1.05rem;transition:transform .08s ease}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:linear-gradient(135deg,#29d980,#25D366);color:#0b1b12}
  .btn.secondary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#1b0b08}

  .row{display:flex;gap:12px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:.92rem}
  .hint{font-size:.88rem;color:var(--muted);margin-top:6px;min-height:20px}
  .total{font-weight:900;font-size:1.7rem;text-align:center;margin-top:8px;color:var(--brand);opacity:0;transition:opacity .6s ease}
  .total.show{opacity:1}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:560px){.grid2{grid-template-columns:1fr}}

  .slide{animation:slideUp .35s ease forwards}
  @keyframes slideUp{from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)}}
  .hidden{display:none}

  .tag{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <header class="card">
    <img src="icon-192.png" alt="Ben’s Humpin’ & Dumpin’ logo">
    <h1>Instant Quote</h1>
    <div class="sub">Fast estimate. Final price confirmed after photos & access check.</div>
    <div class="build">Build r24</div>
  </header>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <label for="jobType" style="margin:0;color:#fff">Job Type</label>
      <span class="tag">WhatsApp checkout</span>
    </div>

    <select id="jobType">
      <option value="" selected disabled hidden>Choose a job type…</option>
      <option value="tip">1️⃣ Tip Run</option>
      <option value="move">2️⃣ House Move</option>
      <option value="fb">3️⃣ Facebook Marketplace Pickup/Drop-off</option>
      <option value="shop">4️⃣ Emergency Shop Run</option>
      <option value="student">5️⃣ Student Relocation (to/from uni)</option>
      <option value="business">6️⃣ Business Enquiries / Barter Deals</option>
      <option value="other">7️⃣ Other (Tell me what you need)</option>
    </select>

    <div id="pickupField" class="hidden">
      <label for="addrPickup">Collection address</label>
      <input id="addrPickup" type="text" placeholder="Start typing…" autocomplete="street-address">
    </div>

    <div id="addrDropWrap" class="hidden">
      <label for="addrDrop">Delivery address</label>
      <input id="addrDrop" type="text" placeholder="Start typing…" autocomplete="street-address">
    </div>

    <!-- Shop: time selector (affects base rate) -->
    <div id="shopTimeWrap" class="hidden">
      <label for="shopTime">Run time (for shop runs)</label>
      <select id="shopTime">
        <option value="before22" selected>Before 10pm</option>
        <option value="after22">After 10pm</option>
      </select>
    </div>

    <input id="mileage" type="number" class="hidden" readonly>

    <div id="twoManWrap" class="hidden">
      <label for="twoMan">Two-person team?</label>
      <select id="twoMan">
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>
    </div>

    <div id="stairsWrap" class="grid2 hidden">
      <div>
        <label for="stairsPickup">Stairs at pickup (floors)</label>
        <input id="stairsPickup" type="number" min="0" step="1" value="0">
      </div>
      <div>
        <label for="stairsDrop">Stairs at drop-off (floors)</label>
        <input id="stairsDrop" type="number" min="0" step="1" value="0">
      </div>
    </div>

    <div id="wasteWrap" class="hidden">
      <label for="wasteType">Waste type (Tip runs)</label>
      <select id="wasteType">
        <option value="mixed">Mixed Waste</option>
        <option value="inert">Inert Waste</option>
        <option value="wood">Wood</option>
        <option value="green">Green Waste</option>
        <option value="plaster">Plasterboard</option>
        <option value="mattress">Mattress</option>
        <option value="tyre">Tyre</option>
      </select>
      <div id="qtyWrap" class="hidden">
        <label for="itemQty">Quantity (items)</label>
        <input id="itemQty" type="number" min="1" step="1" value="1">
      </div>
      <div class="hint">We’ll use the minimum disposal fee. If it’s more, Ben confirms from photos.</div>
    </div>

    <div id="descWrap" class="hidden">
      <label for="jobDesc">What is it? (Describe the job)</label>
      <textarea id="jobDesc" placeholder="e.g., swap a sofa for a table; collect a treadmill; business delivery details…"></textarea>
    </div>

    <button id="btnCalc" class="btn secondary" type="button">Calculate Quote</button>
    <div id="routeHint" class="hint">Choose a job type to start.</div>
  </div>

  <div class="card">
    <div id="quoteId" class="muted">Quote ID — (after send)</div>
    <div id="breakdown" class="muted" style="margin-top:6px"></div>
    <div id="total" class="total">Estimated: £0–£0</div>
    <!-- SHOP NOTE (only shows for shop runs) -->
    <div id="shopNote" class="muted hidden" style="margin-top:6px">No minimum charge — you only pay for the job.</div>
    <div class="hr"></div>
    <div class="muted"><strong>Estimate only.</strong> Final price depends on access, load & photos. Ben confirms before booking.</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnWhatsApp" class="btn primary hidden" type="button">Send to WhatsApp</button>
    </div>
    <div class="hint" style="margin-top:8px">WhatsApp opens with your details and Ben’s number prefilled.</div>
  </div>
</div>

<script src="config.js?v=r24"></script>
<script>
if (!window.BHD_CONFIG) {
  console.warn("config.js missing — using fallback defaults");
  window.BHD_CONFIG = {
    homeAddress: "15 Primrose Hill, Doddington, Cambs, PE15 0SU",
    waterbeachAddress: "Waterbeach Waste Management Park, Ely Road, Waterbeach, Cambridge CB25 9PG",
    minTotal: 55,
    rates: {
      baseFeeDefault: 35, baseFeeMove: 50,
      baseFeeShopBefore22: 25, baseFeeShopAfter22: 40,
      mileagePerMile: 0.40, twoMan: 20, stairsPerFloor: 5,
      disposal: {
        mixed:{ ratePerTonne:150, minFee:40 }, inert:{ ratePerTonne:25, minFee:20 },
        wood:{ ratePerTonne:75, minFee:20 }, green:{ ratePerTonne:30, minFee:20 },
        plaster:{ ratePerTonne:130, minFee:40 }, mattress:{ each:20 }, tyre:{ each:6 }
      }
    },
    rangePct: { tip:.15,business:.15,other:.15,move:.12,fb:.12,student:.12,shop:.10 },
    whatsappNumber: "447717463496"
  };
}

/* Config pulls */
const HOME_ADDR = BHD_CONFIG.homeAddress;
const WATERBEACH_ADDR = BHD_CONFIG.waterbeachAddress;
const RATES = BHD_CONFIG.rates;
const MIN_TOTAL = BHD_CONFIG.minTotal;
const RANGE_PCT = BHD_CONFIG.rangePct;
const BUSINESS_WHATSAPP = BHD_CONFIG.whatsappNumber;

/* DOM */
const els = {
  jobType: document.getElementById('jobType'),
  pickupField: document.getElementById('pickupField'),
  addrPickup: document.getElementById('addrPickup'),
  addrDrop: document.getElementById('addrDrop'),
  addrDropWrap: document.getElementById('addrDropWrap'),
  shopTimeWrap: document.getElementById('shopTimeWrap'),
  shopTime: document.getElementById('shopTime'),
  twoManWrap: document.getElementById('twoManWrap'),
  twoMan: document.getElementById('twoMan'),
  stairsWrap: document.getElementById('stairsWrap'),
  stairsPickup: document.getElementById('stairsPickup'),
  stairsDrop: document.getElementById('stairsDrop'),
  wasteType: document.getElementById('wasteType'),
  wasteWrap: document.getElementById('wasteWrap'),
  qtyWrap: document.getElementById('qtyWrap'),
  itemQty: document.getElementById('itemQty'),
  descWrap: document.getElementById('descWrap'),
  jobDesc: document.getElementById('jobDesc'),
  btnCalc: document.getElementById('btnCalc'),
  routeHint: document.getElementById('routeHint'),
  breakdown: document.getElementById('breakdown'),
  total: document.getElementById('total'),
  quoteId: document.getElementById('quoteId'),
  mileage: document.getElementById('mileage'),
  btnWA: document.getElementById('btnWhatsApp'),
  shopNote: document.getElementById('shopNote')
};

/* State */
let pickupAddress = "", dropAddress = "";
let directions = null;

/* Quote ID = datetime */
function nextQuoteId(){
  const now = new Date();
  const pad = n => String(n).padStart(2,"0");
  const date = now.getFullYear()+pad(now.getMonth()+1)+pad(now.getDate());
  const time = pad(now.getHours())+pad(now.getMinutes())+pad(now.getSeconds());
  return `ID${date}-${time}`;
}

/* Helpers */
const round5 = v => Math.round(v/5)*5;
const show = el => {el.classList.remove('hidden'); el.classList.add('slide');}
const hide = el => {el.classList.add('hidden'); el.classList.remove('slide');}

/* UI state */
function setJobTypeUI(){
  const jt = els.jobType.value;
  [els.pickupField, els.addrDropWrap, els.wasteWrap, els.twoManWrap, els.stairsWrap, els.descWrap, els.shopTimeWrap].forEach(hide);
  if (!jt){ els.routeHint.textContent = "Choose a job type to start."; return; }

  show(els.pickupField);

  if (jt === "tip"){
    show(els.wasteWrap);
    els.routeHint.textContent = "Mileage: Home → Collection → Waterbeach (return added only if Home→Collection > 50mi).";
  } else if (jt === "move" || jt === "fb" || jt === "student"){
    show(els.addrDropWrap); show(els.twoManWrap); show(els.stairsWrap);
    els.routeHint.textContent = "Mileage: Home → Pickup → Delivery.";
  } else if (jt === "shop"){
    show(els.addrDropWrap); show(els.shopTimeWrap);
    els.routeHint.textContent = "Mileage: Home → Shop → Delivery.";
  } else if (jt === "business" || jt === "other"){
    show(els.addrDropWrap); show(els.descWrap);
    els.routeHint.textContent = "Mileage: Home → Pickup → Delivery.";
  }
}

/* Waste UI */
function onWasteTypeChanged(){
  const t = els.wasteType.value;
  els.qtyWrap.classList.toggle('hidden', !(t==="mattress" || t==="tyre"));
}

/* Disposal calc */
function calcDisposal(){
  const t = els.wasteType.value;
  if (t === "mattress" || t === "tyre"){
    const each = t==="mattress" ? RATES.disposal.mattress.each : RATES.disposal.tyre.each;
    const qty = Math.max(1, parseInt(els.itemQty.value)||1);
    return { fee: qty*each, detail: `${t} x ${qty} @ £${each.toFixed(2)}` };
  }
  const d = RATES.disposal[t];
  return { fee: d.minFee, detail: `Minimum disposal for ${t} (rate £${d.ratePerTonne}/t)` };
}

/* Base fee */
function baseFeeFor(jt){
  if (jt === "move") return RATES.baseFeeMove;
  if (jt === "shop") return (els.shopTime.value === "after22") ? RATES.baseFeeShopAfter22 : RATES.baseFeeShopBefore22;
  return RATES.baseFeeDefault;
}

/* Totals + range (min applies to all EXCEPT shop runs) */
function calculate(){
  const jt = els.jobType.value;
  if (!jt){ els.breakdown.innerHTML=""; els.total.textContent="Estimated: £0–£0"; els.total.classList.remove('show'); els.shopNote.classList.add('hidden'); return {total:0,lines:[],range:[0,0]}; }

  const miles = parseFloat(els.mileage.value)||0;
  const base = baseFeeFor(jt);
  const twoManFee = (jt==="tip" || jt==="shop" || jt==="business" || jt==="other") ? 0 : (els.twoMan.value==="yes" ? RATES.twoMan : 0);
  const stairsCost = (jt==="tip" || jt==="shop" || jt==="business" || jt==="other") ? 0 :
    ((parseInt(els.stairsPickup.value)||0) + (parseInt(els.stairsDrop.value)||0)) * RATES.stairsPerFloor;
  const mileageCost = miles * RATES.mileagePerMile;
  const disp = (jt==="tip") ? calcDisposal() : { fee: 0, detail: "" };

  let total = base + mileageCost + stairsCost + twoManFee + disp.fee;

  const lines = [
    `Base: £${base.toFixed(2)}`,
    `Mileage: £${mileageCost.toFixed(2)}`
  ];
  if (stairsCost) lines.push(`Stairs: £${stairsCost.toFixed(2)}`);
  if (twoManFee) lines.push(`Two-person: £${twoManFee.toFixed(2)}`);
  if (jt==="tip") lines.push(`Disposal: £${disp.fee.toFixed(2)} — ${disp.detail}`);
  if (jt==="shop") lines.push(`Run time: ${els.shopTime.value === "after22" ? "After 10pm" : "Before 10pm"}`);

  // Apply £55 minimum to all EXCEPT shop runs
  if (jt !== "shop" && total < MIN_TOTAL){ lines.push(`Minimum charge applied`); total = MIN_TOTAL; }

  const pct = RANGE_PCT[jt] ?? 0.12;
  let low = total * (1 - pct);
  let high = total * (1 + pct);
  if (jt !== "shop") { low = Math.max(MIN_TOTAL, low); high = Math.max(MIN_TOTAL, high); }
  low = round5(low); high = round5(high); if (high < low) high = low;

  els.breakdown.innerHTML = lines.length ? ('• ' + lines.join('<br>• ')) : '';
  els.total.textContent = `Estimated: £${low.toFixed(0)}–£${high.toFixed(0)}`;
  els.total.classList.add('show');

  // Show/Hide the shop note
  if (jt === "shop") { els.shopNote.classList.remove('hidden'); }
  else { els.shopNote.classList.add('hidden'); }

  els.btnWA.classList.remove('hidden'); els.btnWA.classList.add('slide');

  return { total, lines, range: [low, high] };
}

/* Directions helpers */
const metersToMiles = m => m / 1609.344;
const legsMiles = legs => legs.reduce((s,l)=> s + (l.distance?.value||0), 0);

/* One-way mileage per rules (+ >50mi tip rule adds full loop) */
function calcMileage(){
  const jt = els.jobType.value;
  if (!directions){ calculate(); return; }
  if (!pickupAddress){ els.routeHint.textContent = "Enter collection address."; return; }
  if (jt!=="tip" && !dropAddress){ els.routeHint.textContent = "Enter delivery address."; return; }

  // TIP RUN
  if (jt === "tip"){
    // Check Home → Collection distance
    directions.route({ origin: HOME_ADDR, destination: pickupAddress, travelMode:'DRIVING' },
      (res,status)=>{
        if(status!=="OK"){ els.routeHint.textContent = "Route error"; return; }
        const milesHomeToPickup = metersToMiles(legsMiles(res.routes[0].legs));
        if (milesHomeToPickup <= 50){
          // One-way: Collection → Waterbeach
          directions.route({
            origin: pickupAddress, destination: WATERBEACH_ADDR, travelMode:'DRIVING'
          }, (r2,s2)=>{
            if(s2!=="OK"){ els.routeHint.textContent = "Route error"; return; }
            const miles = metersToMiles(legsMiles(r2.routes[0].legs));
            els.mileage.value = miles.toFixed(1);
            els.routeHint.textContent = `Mileage (one-way): ${miles.toFixed(1)} mi.`;
            calculate();
          });
        } else {
          // >50mi rule: Home → Collection → Waterbeach → Home
          directions.route({
            origin: HOME_ADDR,
            destination: HOME_ADDR,
            waypoints:[{location:pickupAddress, stopover:true},{location:WATERBEACH_ADDR, stopover:true}],
            travelMode:'DRIVING'
          }, (r2,s2)=>{
            if(s2!=="OK"){ els.routeHint.textContent = "Route error"; return; }
            const miles = metersToMiles(legsMiles(r2.routes[0].legs));
            els.mileage.value = miles.toFixed(1);
            els.routeHint.textContent = `>50mi rule: ${miles.toFixed(1)} mi.`;
            calculate();
          });
        }
      }
    );
    return;
  }

  // SHOP: Home → Shop → Delivery (one-way)
  if (jt === "shop"){
    directions.route({
      origin: HOME_ADDR, destination: dropAddress,
      waypoints:[{location: pickupAddress, stopover:true}],
      travelMode:'DRIVING'
    }, (res,status)=>{
      if(status!=="OK"){ els.routeHint.textContent = "Route error"; return; }
      const miles = metersToMiles(legsMiles(res.routes[0].legs));
      els.mileage.value = miles.toFixed(1);
      els.routeHint.textContent = `Mileage (one-way): ${miles.toFixed(1)} mi.`;
      calculate();
    });
    return;
  }

  // Others: Home → Pickup → Delivery (one-way)
  directions.route({
    origin: HOME_ADDR, destination: dropAddress,
    waypoints:[{location: pickupAddress, stopover:true}],
    travelMode:'DRIVING'
  }, (res,status)=>{
    if(status!=="OK"){ els.routeHint.textContent = "Route error"; return; }
    const miles = metersToMiles(legsMiles(res.routes[0].legs));
    els.mileage.value = miles.toFixed(1);
    els.routeHint.textContent = `Mileage (one-way): ${miles.toFixed(1)} mi.`;
    calculate();
  });
}

/* WhatsApp */
function sendWhatsApp(){
  const nowId = nextQuoteId();
  els.quoteId.textContent = "Quote ID — " + nowId;

  const { lines, range } = calculate();
  const jt = els.jobType.value;

  const msgLines = [
    "Hey Ben! I need something Humpin' & Dumpin'",
    `Quote ID: ${nowId}`,
    `Job Type: ${jt || "N/A"}`,
    `Collection: ${pickupAddress || els.addrPickup.value.trim() || "N/A"}`,
    (jt==="tip" ? `Destination: Waterbeach Waste Management Park` : `Delivery: ${dropAddress || els.addrDrop.value.trim() || "N/A"}`),
    (jt==="shop" ? `Run time: ${els.shopTime.value==="after22" ? "After 10pm" : "Before 10pm"}` : ""),
    (lines.length ? `\nBreakdown:\n- ${lines.join("\n- ")}` : ""),
    `\nEstimated range: £${range[0].toFixed(0)}–£${range[1].toFixed(0)}`
  ].filter(Boolean);
  const textMsg = msgLines.join("\n");

  const url = `https://wa.me/${BUSINESS_WHATSAPP}?text=${encodeURIComponent(textMsg)}`;
  window.open(url, '_blank');
}

/* Google Places / Directions */
function initMapsStuff(){
  try{
    directions = new google.maps.DirectionsService();
    const opt = { fields: ["formatted_address"], componentRestrictions: { country: ["gb"] } };
    const ap = document.getElementById('addrPickup');
    const ad = document.getElementById('addrDrop');
    if (ap){
      const ac1 = new google.maps.places.Autocomplete(ap, opt);
      ac1.addListener('place_changed', ()=>{ const p=ac1.getPlace(); pickupAddress = p?.formatted_address || ap.value.trim(); });
    }
    if (ad){
      const ac2 = new google.maps.places.Autocomplete(ad, opt);
      ac2.addListener('place_changed', ()=>{ const p=ac2.getPlace(); dropAddress = p?.formatted_address || ad.value.trim(); });
    }
  }catch(e){ console.warn("Maps init failed:", e); }
}
window.initMapsStuff = initMapsStuff;

/* Events */
document.addEventListener('DOMContentLoaded', ()=>{
  setJobTypeUI();
  onWasteTypeChanged();

  els.jobType.addEventListener('change', setJobTypeUI);
  els.wasteType.addEventListener('change', onWasteTypeChanged);
  els.btnCalc.addEventListener('click', ()=>{ calcMileage(); });
  els.btnWA.addEventListener('click', sendWhatsApp);
});
</script>

<!-- Google Maps (key injected by your GH Action) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=__MAPS_API_KEY__&libraries=places&callback=initMapsStuff&v=9&cbust=r24"
  onerror="document.getElementById('routeHint').textContent='Maps failed to load. Estimate will exclude mileage.'">
</script>
</body>
</html>