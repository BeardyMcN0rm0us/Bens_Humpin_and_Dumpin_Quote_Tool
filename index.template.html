<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ben’s Humpin’ & Dumpin’ — Instant Quote</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icon-192.png">
<meta name="theme-color" content="#000000" />
<link rel="stylesheet" href="style.css?v=r34">
</head>
<body>

<!-- Splash (black bg + centred logo) -->
<div id="splash"><img src="icon-192.png" alt="Ben’s Humpin’ & Dumpin’ logo"></div>

<div class="wrap">
  <header class="card">
    <img src="icon-192.png" alt="Ben’s Humpin’ & Dumpin’ logo">
    <h1>Instant Quote</h1>
    <div class="sub">Fast estimate. Final price confirmed after photos & access check.</div>
    <div class="build">Build r34</div>
  </header>

  <div class="card" id="cfgWarn" style="display:none">
    <div class="warn">Pricing config not loaded — refresh the page. If it persists, check <code>config.js</code> is present.</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <label for="jobType" style="margin:0;color:#fff">Job Type</label>
      <span class="tag">WhatsApp checkout</span>
    </div>

    <select id="jobType">
      <option value="" selected disabled hidden>Choose a job type…</option>
      <option value="tip">Tip Run</option>
      <option value="move">House Move</option>
      <option value="fb">Facebook Marketplace Pickup/Drop-off</option>
      <option value="shop">Emergency Shop Run</option>
      <option value="student">Student Relocation (to/from uni)</option>
      <option value="ikea">IKEA Collect / Collect & Build</option>
      <option value="business">Business Enquiries / Barter Deals</option>
      <option value="other">Other (Tell me what you need)</option>
    </select>

    <!-- IKEA mode/store -->
    <div id="ikeaModeWrap" class="hidden">
      <label for="ikeaMode">IKEA service</label>
      <select id="ikeaMode">
        <option value="collect" selected>Collect Only</option>
        <option value="collectBuild">Collect & Build</option>
      </select>
    </div>
    <div id="ikeaStoreWrap" class="hidden">
      <label for="ikeaStore">IKEA store</label>
      <select id="ikeaStore"></select>
      <div class="hint">Choosing a store fills the collection address (you can edit it).</div>
    </div>

    <!-- Addresses -->
    <div id="pickupField" class="hidden">
      <label for="addrPickup">Collection address</label>
      <input id="addrPickup" type="text" placeholder="Start typing…" autocomplete="street-address">
    </div>
    <div id="addrDropWrap" class="hidden">
      <label for="addrDrop">Delivery address</label>
      <input id="addrDrop" type="text" placeholder="Start typing…" autocomplete="street-address">
    </div>

    <!-- Shop timing -->
    <div id="shopTimeWrap" class="hidden">
      <label for="shopTime">Run time (for shop runs)</label>
      <select id="shopTime">
        <option value="before22" selected>Before 10pm</option>
        <option value="after22">After 10pm</option>
      </select>
    </div>

    <!-- IKEA build qty + quick picks -->
    <div id="ikeaQtyWrap" class="hidden">
      <label for="ikeaQty">How many items to build?</label>
      <input id="ikeaQty" type="number" min="1" step="1" value="1">
      <div id="ikeaQuickPick" class="row" style="margin-top:8px;flex-wrap:wrap;gap:6px"></div>
      <div class="hint">Tap an item to auto-fill description and bump the quantity.</div>
    </div>

    <!-- Hidden mileage holder -->
    <input id="mileage" type="number" class="hidden" readonly>

    <!-- Team & stairs -->
    <div id="twoManWrap" class="hidden">
      <label for="twoMan">Two-person team?</label>
      <select id="twoMan"><option value="no">No</option><option value="yes">Yes</option></select>
    </div>
    <div id="stairsWrap" class="grid2 hidden">
      <div><label for="stairsPickup">Stairs at pickup (floors)</label><input id="stairsPickup" type="number" min="0" step="1" value="0"></div>
      <div><label for="stairsDrop">Stairs at drop-off (floors)</label><input id="stairsDrop" type="number" min="0" step="1" value="0"></div>
    </div>

    <!-- Waste for tip runs -->
    <div id="wasteWrap" class="hidden">
      <label for="wasteType">Waste type (Tip runs)</label>
      <select id="wasteType"></select>
      <div class="hint">We’ll use the **minimum disposal fee (25% of rate)** unless load is heavier; Ben confirms from photos.</div>
    </div>

    <!-- Description -->
    <div id="descWrap" class="hidden">
      <label for="jobDesc">What is it? (Describe the job)</label>
      <textarea id="jobDesc" placeholder="e.g., Billy bookcase + Malm drawers; room & access notes…"></textarea>
    </div>

    <button id="btnCalc" class="btn secondary" type="button">Calculate Quote</button>
    <div id="routeHint" class="hint">Choose a job type to start.</div>
  </div>

  <div class="card">
    <div id="quoteId" class="muted">Quote ID — (after send)</div>
    <div id="breakdown" class="muted" style="margin-top:6px"></div>
    <div id="total" class="total">Estimated: £0–£0</div>
    <div id="shopNote" class="muted hidden" style="margin-top:6px">No minimum charge — you only pay for the job.</div>
    <div class="hr"></div>
    <div class="muted"><strong>Estimate only.</strong> Final price depends on access, load & photos. Ben confirms before booking.</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnWhatsApp" class="btn primary hidden" type="button">Send to WhatsApp</button>
    </div>
    <div class="hint" style="margin-top:8px">WhatsApp opens with your details and Ben’s number prefilled.</div>
  </div>

  <footer>
    <span id="versionBadge"></span><br>
    <span id="lastUpdated"></span>
  </footer>
</div>

<!-- Load config FIRST -->
<script src="config.js?v=r34"></script>

<script>
// Guard
(function enforceConfig(){
  if(!window.BHD_CONFIG){
    document.getElementById('cfgWarn').style.display='block';
  }
})();

// Shortcuts
const CFG = window.BHD_CONFIG || {};
const ADDR = { home: CFG.homeAddress, tipSite: CFG.waterbeachAddress };
const BASE = CFG.baseFees || {};
const RANGES = CFG.rangePct || {};
const MIN_BY = CFG.minByType || {};
const DISP = CFG.disposal || {};
const DISP_MIN = Number(CFG.disposalMinPct ?? 0.25);
const UI = (CFG.ui||{});
const IKEA_STORES = CFG.ikeaStores || [];
const IKEA_ITEMS  = CFG.ikeaItems  || [];
const PRICE = {
  mileagePerMile: Number(CFG.mileagePerMile||0),
  twoMan: Number(CFG.twoManSurcharge||0),
  stairsPerFloor: Number(CFG.stairsPerFloor||0),
  ikeaAssemblyPerItem: Number(CFG.ikeaAssemblyPerItem||0)
};

// DOM helper
const $=id=>document.getElementById(id);

// DOM
const els={
  jobType:$('#jobType'),
  ikeaModeWrap:$('#ikeaModeWrap'), ikeaMode:$('#ikeaMode'),
  ikeaStoreWrap:$('#ikeaStoreWrap'), ikeaStore:$('#ikeaStore'),
  pickupField:$('#pickupField'), addrPickup:$('#addrPickup'),
  addrDropWrap:$('#addrDropWrap'), addrDrop:$('#addrDrop'),
  shopTimeWrap:$('#shopTimeWrap'), shopTime:$('#shopTime'),
  ikeaQtyWrap:$('#ikeaQtyWrap'), ikeaQty:$('#ikeaQty'), ikeaQuickPick:$('#ikeaQuickPick'),
  twoManWrap:$('#twoManWrap'), twoMan:$('#twoMan'),
  stairsWrap:$('#stairsWrap'), stairsPickup:$('#stairsPickup'), stairsDrop:$('#stairsDrop'),
  wasteWrap:$('#wasteWrap'), wasteType:$('#wasteType'),
  descWrap:$('#descWrap'), jobDesc:$('#jobDesc'),
  btnCalc:$('#btnCalc'), routeHint:$('#routeHint'),
  breakdown:$('#breakdown'), total:$('#total'),
  quoteId:$('#quoteId'), mileage:$('#mileage'),
  btnWA:$('#btnWhatsApp'), shopNote:$('#shopNote')
};

// State
let pickupAddress="", dropAddress="", directions=null;

// Helpers
function nextQuoteId(){const n=new Date(),p=v=>String(v).padStart(2,"0");return `ID${n.getFullYear()}${p(n.getMonth()+1)}${p(n.getDate())}-${p(n.getHours())}${p(n.getMinutes())}${p(n.getSeconds())}`;}
const round5=v=>Math.round(v/5)*5, show=el=>{el.classList.remove('hidden');el.classList.add('slide')}, hide=el=>{el.classList.add('hidden');el.classList.remove('slide')};
const metersToMiles=m=>m/1609.344, legsMiles=legs=>legs.reduce((s,l)=>s+(l.distance?.value||0),0);
const pctFor = jt => Number(RANGES[jt] ?? 0.12);
const minFor = jt => { const v = MIN_BY[jt]; return (v === "" || v == null) ? 0 : Math.max(0, Number(v)); };
function baseFeeFor(jt){
  if(jt==="move") return Number(BASE.move ?? BASE.default ?? 0);
  if(jt==="shop") return (els.shopTime.value==="after22") ? Number(BASE.shopAfter22 ?? BASE.default ?? 0) : Number(BASE.shopBefore22 ?? BASE.default ?? 0);
  if(jt==="ikea") return (els.ikeaMode.value === "collectBuild") ? Number(BASE.ikeaCollectBuild ?? BASE.default ?? 0) : Number(BASE.ikeaCollect ?? BASE.default ?? 0);
  return Number(BASE.default ?? 0);
}

// UI logic
function setJobTypeUI(){
  const jt=els.jobType.value;
  [els.pickupField,els.addrDropWrap,els.wasteWrap,els.twoManWrap,els.stairsWrap,els.descWrap,els.shopTimeWrap,els.ikeaModeWrap,els.ikeaStoreWrap,els.ikeaQtyWrap].forEach(hide);
  els.shopNote.classList.add('hidden');

  if(!jt){els.routeHint.textContent="Choose a job type to start.";return;}
  show(els.pickupField);

  if(jt==="tip"){
    show(els.wasteWrap); els.routeHint.textContent="Mileage: Home → Collection → Waterbeach (return added only if Home→Collection > 50mi).";
  } else if (jt==="move"||jt==="fb"||jt==="student"){
    show(els.addrDropWrap); show(els.twoManWrap); show(els.stairsWrap); els.routeHint.textContent="Mileage: Home → Pickup → Delivery.";
  } else if (jt==="shop"){
    show(els.addrDropWrap); show(els.shopTimeWrap);
    if (UI.showShopNoMinNote) els.shopNote.classList.remove('hidden');
    els.routeHint.textContent="Mileage: Home → Shop → Delivery.";
  } else if (jt==="ikea"){
    show(els.ikeaModeWrap); show(els.ikeaStoreWrap); show(els.addrDropWrap); show(els.twoManWrap); show(els.stairsWrap); show(els.descWrap);
    if (els.ikeaMode.value === "collectBuild") show(els.ikeaQtyWrap);
    if (els.ikeaStore.value){ els.addrPickup.value = els.ikeaStore.value; pickupAddress = els.ikeaStore.value; }
    els.routeHint.textContent="Mileage: Home → IKEA store → Delivery.";
  } else if (jt==="business"||jt==="other"){
    show(els.addrDropWrap); show(els.descWrap); els.routeHint.textContent="Mileage: Home → Pickup → Delivery.";
  }
}

// Disposal dropdown from config (tidy labels)
(function populateDisposal(){
  const wc = document.getElementById('wasteType'); if(!wc) return;
  wc.innerHTML = "";
  Object.keys(DISP).forEach(key=>{
    const opt=document.createElement('option');
    opt.value = key;
    opt.textContent = DISP[key].label || key;
    wc.appendChild(opt);
  });
})();

// Disposal calc (min fee = pct * rate)
function calcDisposal(){
  const key=els.wasteType.value;
  const item = DISP[key] || {};
  const rate = Number(item.ratePerTonne || 0);
  const minFee = rate * DISP_MIN;
  return {fee:minFee, detail:`Minimum disposal for ${item.label || key} — 25% of £${rate.toFixed(2)}/t`};
}

// Calculation
function calculate(){
  const jt=els.jobType.value;
  if(!jt){els.breakdown.innerHTML=""; els.total.textContent="Estimated: £0–£0"; els.total.classList.remove('show'); els.shopNote.classList.add('hidden'); return {total:0,lines:[],range:[0,0]}; }

  const miles=parseFloat(els.mileage.value)||0;
  const base=baseFeeFor(jt);
  const twoManFee=(jt==="tip"||jt==="shop"||jt==="business"||jt==="other")?0:(els.twoMan.value==="yes"?PRICE.twoMan:0);
  const stairsCost=(jt==="tip"||jt==="shop"||jt==="business"||jt==="other")?0:((parseInt(els.stairsPickup.value)||0)+(parseInt(els.stairsDrop.value)||0))*PRICE.stairsPerFloor;
  const mileageCost=miles*PRICE.mileagePerMile;
  const disp=(jt==="tip")?calcDisposal():{fee:0,detail:""};

  // IKEA assembly
  let ikeaAssemblyFee=0;
  if(jt==="ikea" && els.ikeaMode.value==="collectBuild"){
    const qty=Math.max(1,parseInt(els.ikeaQty.value)||1);
    ikeaAssemblyFee = qty * PRICE.ikeaAssemblyPerItem;
  }

  let total = base + mileageCost + stairsCost + twoManFee + disp.fee + ikeaAssemblyFee;

  const lines=[`Base: £${base.toFixed(2)}`, `Mileage: £${mileageCost.toFixed(2)}`];
  if(stairsCost) lines.push(`Stairs: £${stairsCost.toFixed(2)}`);
  if(twoManFee) lines.push(`Two-person: £${twoManFee.toFixed(2)}`);
  if(jt==="tip") lines.push(`Disposal: £${disp.fee.toFixed(2)} — ${disp.detail}`);
  if(jt==="shop") lines.push(`Run time: ${els.shopTime.value==="after22"?"After 10pm":"Before 10pm"}`);
  if(jt==="ikea" && ikeaAssemblyFee) lines.push(`Assembly: £${ikeaAssemblyFee.toFixed(2)} (${els.ikeaQty.value} item${(parseInt(els.ikeaQty.value)||1)>1?"s":""})`);

  // Apply per-type minimum if set
  const MIN = minFor(jt);
  if (MIN > 0 && total < MIN){ lines.push(`Minimum charge applied`); total = MIN; }

  const pct=pctFor(jt);
  let low = total * (1 - pct);
  let high = total * (1 + pct);
  if (MIN > 0) { low = Math.max(MIN, low); high = Math.max(MIN, high); }
  low=round5(low); high=round5(high); if(high<low) high=low;

  els.breakdown.innerHTML = lines.length ? ('• ' + lines.join('<br>• ')) : '';
  els.total.textContent = `Estimated: £${low.toFixed(0)}–£${high.toFixed(0)}`;
  els.total.classList.add('show');

  els.shopNote.classList.toggle('hidden', !(jt==="shop" && (CFG.ui?.showShopNoMinNote)));

  els.btnWA.classList.remove('hidden'); els.btnWA.classList.add('slide');
  return { total, lines, range:[low,high] };
}

// Directions helpers
function metersToMiles(m){return m/1609.344}
function legsMiles(legs){return legs.reduce((s,l)=>s+(l.distance?.value||0),0)}

// Mileage rules (one-way, with special tip >50mi)
function calcMileage(){
  const jt=els.jobType.value;
  if(!directions){ calculate(); return; }
  if(!pickupAddress){ els.routeHint.textContent="Enter collection address."; return; }
  if(jt!=="tip" && !dropAddress){ els.routeHint.textContent="Enter delivery address."; return; }

  // TIP RUN
  if(jt==="tip"){
    directions.route({origin:ADDR.home,destination:pickupAddress,travelMode:'DRIVING'},(res,status)=>{
      if(status!=="OK"){els.routeHint.textContent="Route error";return;}
      const milesHomeToPickup=metersToMiles(legsMiles(res.routes[0].legs));
      if(milesHomeToPickup<=50){
        // One-way: Collection → Waterbeach
        directions.route({origin:pickupAddress,destination:ADDR.tipSite,travelMode:'DRIVING'},(r2,s2)=>{
          if(s2!=="OK"){els.routeHint.textContent="Route error";return;}
          const miles=metersToMiles(legsMiles(r2.routes[0].legs)); els.mileage.value=miles.toFixed(1);
          els.routeHint.textContent=`Mileage (one-way): ${miles.toFixed(1)} mi.`; calculate();
        });
      }else{
        // >50mi rule: Home → Collection → Waterbeach → Home
        directions.route({origin:ADDR.home,destination:ADDR.home,waypoints:[{location:pickupAddress,stopover:true},{location:ADDR.tipSite,stopover:true}],travelMode:'DRIVING'},(r2,s2)=>{
          if(s2!=="OK"){els.routeHint.textContent="Route error";return;}
          const miles=metersToMiles(legsMiles(r2.routes[0].legs)); els.mileage.value=miles.toFixed(1);
          els.routeHint.textContent=`>50mi rule: ${miles.toFixed(1)} mi.`; calculate();
        });
      }
    });
    return;
  }

  // Others (incl. SHOP & IKEA): Home → Pickup → Delivery (one-way)
  directions.route({origin:ADDR.home,destination:dropAddress,waypoints:[{location:pickupAddress,stopover:true}],travelMode:'DRIVING'},(res,status)=>{
    if(status!=="OK"){els.routeHint.textContent="Route error";return;}
    const miles=metersToMiles(legsMiles(res.routes[0].legs)); els.mileage.value=miles.toFixed(1);
    els.routeHint.textContent=`Mileage (one-way): ${miles.toFixed(1)} mi.`; calculate();
  });
}

// WhatsApp
function sendWhatsApp(){
  const id=nextQuoteId(); els.quoteId.textContent="Quote ID — "+id;
  const {lines,range}=calculate(); const jt=els.jobType.value;

  const ikeaBits = (jt==="ikea")
    ? [`IKEA Mode: ${els.ikeaMode.value==="collectBuild"?"Collect & Build":"Collect Only"}`,
       `IKEA Store: ${els.ikeaStore.options[els.ikeaStore.selectedIndex]?.text || "N/A"}`]
    : [];

  const msgLines=[
    "Hey Ben! I need something Humpin' & Dumpin'",
    `Quote ID: ${id}`,
    `Job Type: ${jt || "N/A"}`,
    ...ikeaBits,
    `Collection: ${pickupAddress || els.addrPickup.value.trim() || "N/A"}`,
    (jt==="tip" ? `Destination: Waterbeach Waste Management Park` : `Delivery: ${dropAddress || els.addrDrop.value.trim() || "N/A"}`),
    (jt==="shop" ? `Run time: ${els.shopTime.value==="after22"?"After 10pm":"Before 10pm"}` : ""),
    (lines.length ? `\nBreakdown:\n- ${lines.join("\n- ")}` : ""),
    `\nEstimated range: £${range[0].toFixed(0)}–£${range[1].toFixed(0)}`
  ].filter(Boolean);

  const url=`https://wa.me/${CFG.whatsappNumber}?text=${encodeURIComponent(msgLines.join("\n"))}`;
  window.open(url,'_blank');
}

// Google Places / Directions
function initMapsStuff(){
  try{
    directions=new google.maps.DirectionsService();
    const opt={fields:["formatted_address"],componentRestrictions:{country:["gb"]}};
    const ap=document.getElementById('addrPickup'), ad=document.getElementById('addrDrop');
    if(ap){const ac1=new google.maps.places.Autocomplete(ap,opt); ac1.addListener('place_changed',()=>{const p=ac1.getPlace(); pickupAddress=p?.formatted_address||ap.value.trim();});}
    if(ad){const ac2=new google.maps.places.Autocomplete(ad,opt); ac2.addListener('place_changed',()=>{const p=ac2.getPlace(); dropAddress=p?.formatted_address||ad.value.trim();});}
    // capture manual typing too
    ap.addEventListener('input', ()=>{ pickupAddress = ap.value.trim(); });
    ad.addEventListener('input', ()=>{ dropAddress = ad.value.trim(); });
  }catch(e){ console.warn("Maps init failed:", e); }
}
window.initMapsStuff=initMapsStuff;

// Populate IKEA stores & quick-picks
(function initIkeaStores(){
  const el = document.getElementById('ikeaStore'); if(!el) return;
  el.innerHTML = "";
  const ph = document.createElement('option'); ph.value=""; ph.textContent="Select IKEA store…"; ph.disabled=true; ph.selected=true;
  el.appendChild(ph);
  (IKEA_STORES||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.address; o.textContent=s.name; el.appendChild(o); });
})();
(function initIkeaQuickPick(){
  const wrap=document.getElementById('ikeaQuickPick'); if(!wrap) return;
  wrap.innerHTML = "";
  (IKEA_ITEMS||[]).forEach(item=>{
    const b=document.createElement('button'); b.type="button"; b.textContent=item.name; b.className="btn secondary";
    b.style.padding="6px 10px"; b.style.fontSize="0.85rem"; b.style.flex="0 0 auto";
    b.addEventListener('click',()=>{
      els.jobDesc.value = els.jobDesc.value ? (els.jobDesc.value + "; " + item.name) : item.name;
      const n = Math.max(0, parseInt(els.ikeaQty.value||"0",10));
      els.ikeaQty.value = n + (item.qty||1);
    });
    wrap.appendChild(b);
  });
})();

// Events
document.addEventListener('DOMContentLoaded',()=>{
  // Splash + footer
  const splash = document.getElementById('splash');
  const vb = document.getElementById('versionBadge');
  const lu = document.getElementById('lastUpdated');
  if (vb && CFG.version) vb.textContent = `Version: ${CFG.version}`;
  lu.textContent=`Last updated: ${new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`;
  setTimeout(()=>{ splash.classList.add('hide'); setTimeout(()=> splash.remove(), 450); }, Number(CFG.ui?.splashMs || 4000));

  setJobTypeUI();
  els.jobType.addEventListener('change', setJobTypeUI);
  els.btnCalc.addEventListener('click', ()=>{ calcMileage(); });
  els.btnWA.addEventListener('click', sendWhatsApp);
});
</script>

<!-- Google Maps (key injected by your GH Action) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=__MAPS_API_KEY__&libraries=places&callback=initMapsStuff&v=9&cbust=r34"
  onerror="document.getElementById('routeHint').textContent='Maps failed to load. Estimate will exclude mileage.'">
</script>
</body>
</html>